<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Debug - ì¦ì‚°ë„ ê²½ì£¼ ë…¸ì„œë„ì¥</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #C8102E;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #C8102E;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .admin-badge {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .inactive-badge {
            background: #999;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .test-section {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-left: 4px solid #C8102E;
        }
        button {
            background: #C8102E;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #A00C28;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Users í…Œì´ë¸” ë””ë²„ê·¸</h1>
        
        <div class="info">
            <strong>â„¹ï¸ ì´ í˜ì´ì§€ëŠ” ë””ë²„ê¹…ìš©ì…ë‹ˆë‹¤.</strong><br>
            Users í…Œì´ë¸”ì˜ ëª¨ë“  ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•˜ê³ , ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>

        <div style="margin-bottom: 20px;">
            <button onclick="loadUsers()">ğŸ”„ ì‚¬ìš©ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="testAdminLogin()">ğŸ§ª Admin ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testTaeul21Login()">ğŸ§ª taeul21 ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
            <button onclick="createDefaultAccounts()">â• ê¸°ë³¸ ê³„ì • ìƒì„±</button>
            <button onclick="updatePassword()">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>

        <h2>ğŸ“Š ì „ì²´ ì‚¬ìš©ì ëª©ë¡</h2>
        <div id="userCount" style="margin-bottom: 10px; font-weight: 600;"></div>
        <table id="usersTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ì•„ì´ë””</th>
                    <th>ì´ë¦„</th>
                    <th>ì—°ë½ì²˜</th>
                    <th>ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ</th>
                    <th>ê´€ë¦¬ì</th>
                    <th>í™œì„±</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">
                        ë¡œë”© ì¤‘...
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="test-section">
            <h3>ğŸ§ª ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ í…ŒìŠ¤íŠ¸</h3>
            <p>simpleHash í•¨ìˆ˜ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹œí™”í•©ë‹ˆë‹¤.</p>
            <input type="text" id="testPassword" placeholder="í…ŒìŠ¤íŠ¸í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" 
                   style="padding: 8px; width: 300px; margin-right: 10px;">
            <button onclick="testHash()">í•´ì‹œ ê³„ì‚°</button>
            <div id="hashResult" class="test-result" style="display: none;">
                <strong>ì…ë ¥:</strong> <span id="inputPassword"></span><br>
                <strong>í•´ì‹œ:</strong> <span id="outputHash"></span>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
            <p>íŠ¹ì • ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.</p>
            <input type="text" id="updateUsername" placeholder="ì•„ì´ë”” (ì˜ˆ: taeul21)" 
                   style="padding: 8px; width: 200px; margin-right: 10px;">
            <input type="text" id="updatePassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ì˜ˆ: haewon2000!)" 
                   style="padding: 8px; width: 200px; margin-right: 10px;">
            <button onclick="updatePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
            <div id="updateResult" class="test-result" style="display: none; margin-top: 10px;">
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
            <div id="loginTestResult" class="test-result">
                í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¡œê·¸ì¸ì„ ì‹œí—˜í•´ë³´ì„¸ìš”.
            </div>
        </div>
    </div>

    <script>
        // Simple Hash Function (main.jsì™€ ë™ì¼)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        async function loadUsers() {
            try {
                const response = await fetch('tables/users?limit=1000');
                if (!response.ok) throw new Error('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                
                const data = await response.json();
                const users = data.data || [];
                
                document.getElementById('userCount').textContent = 
                    `ì´ ${users.length}ëª…ì˜ ì‚¬ìš©ìê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;
                
                const tbody = document.getElementById('usersTableBody');
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. "ê¸°ë³¸ ê³„ì • ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td style="font-size: 12px;">${user.id.substring(0, 8)}...</td>
                        <td><strong>${user.username}</strong></td>
                        <td>${user.name}</td>
                        <td>${user.phone || '-'}</td>
                        <td style="font-family: monospace; font-size: 12px;">${user.password}</td>
                        <td>${user.is_admin ? '<span class="admin-badge">ê´€ë¦¬ì</span>' : '-'}</td>
                        <td>${user.active ? 'âœ…' : '<span class="inactive-badge">ë¹„í™œì„±</span>'}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('ì‚¬ìš©ì ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #C8102E;">
                            âŒ ì˜¤ë¥˜: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ í…ŒìŠ¤íŠ¸
        function testHash() {
            const password = document.getElementById('testPassword').value;
            if (!password) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const hash = simpleHash(password);
            document.getElementById('inputPassword').textContent = password;
            document.getElementById('outputHash').textContent = hash;
            document.getElementById('hashResult').style.display = 'block';
        }

        // Admin ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
        async function testAdminLogin() {
            await testLogin('admin', 'password');
        }

        // taeul21 ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
        async function testTaeul21Login() {
            await testLogin('taeul21', 'password');
        }

        // ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function testLogin(username, password) {
            const resultDiv = document.getElementById('loginTestResult');
            resultDiv.innerHTML = `<strong>ğŸ”„ í…ŒìŠ¤íŠ¸ ì¤‘...</strong><br>ì•„ì´ë””: ${username}<br>ë¹„ë°€ë²ˆí˜¸: ${password}`;
            
            try {
                const response = await fetch('tables/users?limit=1000');
                if (!response.ok) throw new Error('ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
                
                const data = await response.json();
                const users = data.data || [];
                
                const hashedPassword = simpleHash(password);
                console.log('ì…ë ¥ ë¹„ë°€ë²ˆí˜¸:', password);
                console.log('í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸:', hashedPassword);
                
                const user = users.find(u => {
                    console.log(`ê²€ì‚¬: ${u.username}, í•´ì‹œ: ${u.password}, í™œì„±: ${u.active}`);
                    return u.username === username && u.password === hashedPassword && u.active === true;
                });
                
                if (user) {
                    resultDiv.innerHTML = `
                        <strong>âœ… ë¡œê·¸ì¸ ì„±ê³µ!</strong><br>
                        ì•„ì´ë””: ${username}<br>
                        ë¹„ë°€ë²ˆí˜¸: ${password}<br>
                        ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ: ${hashedPassword}<br>
                        ì´ë¦„: ${user.name}<br>
                        ê´€ë¦¬ì: ${user.is_admin ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}<br>
                        í™œì„± ìƒíƒœ: ${user.active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                    `;
                    resultDiv.style.borderLeft = '4px solid #4CAF50';
                } else {
                    resultDiv.innerHTML = `
                        <strong>âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨</strong><br>
                        ì•„ì´ë””: ${username}<br>
                        ë¹„ë°€ë²ˆí˜¸: ${password}<br>
                        ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ: ${hashedPassword}<br>
                        <br>
                        <strong>ê°€ëŠ¥í•œ ì›ì¸:</strong><br>
                        1. í•´ë‹¹ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ<br>
                        2. ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ<br>
                        3. ê³„ì •ì´ ë¹„í™œì„± ìƒíƒœ<br>
                        <br>
                        DBì—ì„œ ì°¾ì€ ì‚¬ìš©ì ìˆ˜: ${users.length}ëª…<br>
                        í•´ë‹¹ usernameì˜ ì‚¬ìš©ì: ${users.find(u => u.username === username) ? 'ì¡´ì¬í•¨' : 'ì—†ìŒ'}
                    `;
                    resultDiv.style.borderLeft = '4px solid #C8102E';
                    
                    // í•´ë‹¹ usernameì´ ìˆëŠ”ì§€ í™•ì¸
                    const existingUser = users.find(u => u.username === username);
                    if (existingUser) {
                        resultDiv.innerHTML += `<br><br><strong>DBì— ì €ì¥ëœ ì •ë³´:</strong><br>`;
                        resultDiv.innerHTML += `ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ: ${existingUser.password}<br>`;
                        resultDiv.innerHTML += `í™œì„± ìƒíƒœ: ${existingUser.active}<br>`;
                        resultDiv.innerHTML += `í•´ì‹œ ì¼ì¹˜: ${existingUser.password === hashedPassword ? 'âœ…' : 'âŒ'}`;
                    }
                }
                
            } catch (error) {
                console.error('ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                resultDiv.innerHTML = `<strong>âŒ ì˜¤ë¥˜ ë°œìƒ:</strong><br>${error.message}`;
                resultDiv.style.borderLeft = '4px solid #C8102E';
            }
        }

        // ê¸°ë³¸ ê³„ì • ìƒì„±
        async function createDefaultAccounts() {
            if (!confirm('adminê³¼ taeul21 ê³„ì •ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ì¡´ ê³„ì •ì´ ìˆìœ¼ë©´ ì¤‘ë³µ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            const resultDiv = document.getElementById('loginTestResult');
            resultDiv.innerHTML = '<strong>ğŸ”„ ê³„ì • ìƒì„± ì¤‘...</strong>';
            
            try {
                // ë¹„ë°€ë²ˆí˜¸ "password"ë¥¼ í•´ì‹œí™”
                const hashedPassword = simpleHash('password');
                
                // Admin ê³„ì • ìƒì„±
                const adminData = {
                    username: 'admin',
                    password: hashedPassword,
                    name: 'ê´€ë¦¬ì',
                    phone: '010-0000-0000',
                    is_admin: true,
                    active: true
                };
                
                // taeul21 ê³„ì • ìƒì„±
                const taeul21Data = {
                    username: 'taeul21',
                    password: hashedPassword,
                    name: 'ê¹€ì •ì—°',
                    phone: '010-0000-0001',
                    is_admin: true,
                    active: true
                };
                
                // Admin ê³„ì • ìƒì„± ì‹œë„
                try {
                    const adminResponse = await fetch('tables/users', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(adminData)
                    });
                    
                    if (adminResponse.ok) {
                        console.log('âœ… Admin ê³„ì • ìƒì„± ì„±ê³µ');
                    } else {
                        console.log('âš ï¸ Admin ê³„ì • ìƒì„± ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ)');
                    }
                } catch (e) {
                    console.error('Admin ê³„ì • ìƒì„± ì˜¤ë¥˜:', e);
                }
                
                // taeul21 ê³„ì • ìƒì„± ì‹œë„
                try {
                    const taeul21Response = await fetch('tables/users', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(taeul21Data)
                    });
                    
                    if (taeul21Response.ok) {
                        console.log('âœ… taeul21 ê³„ì • ìƒì„± ì„±ê³µ');
                    } else {
                        console.log('âš ï¸ taeul21 ê³„ì • ìƒì„± ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ)');
                    }
                } catch (e) {
                    console.error('taeul21 ê³„ì • ìƒì„± ì˜¤ë¥˜:', e);
                }
                
                resultDiv.innerHTML = `
                    <strong>âœ… ê³„ì • ìƒì„± ì™„ë£Œ!</strong><br><br>
                    ìƒì„±ëœ ê³„ì •:<br>
                    1. admin / password (ê´€ë¦¬ì)<br>
                    2. taeul21 / password (ê´€ë¦¬ì)<br><br>
                    ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ: ${hashedPassword}<br><br>
                    <em>ì‚¬ìš©ì ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.</em>
                `;
                resultDiv.style.borderLeft = '4px solid #4CAF50';
                
                // ìë™ìœ¼ë¡œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(loadUsers, 1000);
                
            } catch (error) {
                console.error('ê³„ì • ìƒì„± ì˜¤ë¥˜:', error);
                resultDiv.innerHTML = `<strong>âŒ ì˜¤ë¥˜ ë°œìƒ:</strong><br>${error.message}`;
                resultDiv.style.borderLeft = '4px solid #C8102E';
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•¨ìˆ˜
        async function updatePassword() {
            const username = document.getElementById('updateUsername').value.trim();
            const newPassword = document.getElementById('updatePassword').value.trim();
            const resultDiv = document.getElementById('updateResult');
            
            if (!username || !newPassword) {
                alert('ì•„ì´ë””ì™€ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<strong>ğŸ”„ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘...</strong>';
            
            try {
                // 1. ì‚¬ìš©ì ì°¾ê¸°
                const response = await fetch('tables/users?limit=1000');
                if (!response.ok) throw new Error('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                
                const data = await response.json();
                const users = data.data || [];
                const user = users.find(u => u.username === username);
                
                if (!user) {
                    resultDiv.innerHTML = `
                        <strong>âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong><br>
                        ì…ë ¥í•œ ì•„ì´ë””: ${username}<br><br>
                        "ê¸°ë³¸ ê³„ì • ìƒì„±" ë²„íŠ¼ìœ¼ë¡œ ê³„ì •ì„ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.
                    `;
                    resultDiv.style.borderLeft = '4px solid #C8102E';
                    return;
                }
                
                // 2. ìƒˆ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œí™”
                const hashedPassword = simpleHash(newPassword);
                
                // 3. ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸ (PATCH ì‚¬ìš©)
                const updateResponse = await fetch(`tables/users/${user.id}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        password: hashedPassword
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const updatedUser = await updateResponse.json();
                
                resultDiv.innerHTML = `
                    <strong>âœ… ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ!</strong><br><br>
                    <strong>ê³„ì • ì •ë³´:</strong><br>
                    â€¢ ì•„ì´ë””: ${username}<br>
                    â€¢ ìƒˆ ë¹„ë°€ë²ˆí˜¸: ${newPassword}<br>
                    â€¢ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ: ${hashedPassword}<br>
                    â€¢ ì´ë¦„: ${user.name}<br>
                    â€¢ í™œì„± ìƒíƒœ: ${user.active ? 'í™œì„±' : 'ë¹„í™œì„±'}<br><br>
                    <em>ì´ì œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em>
                `;
                resultDiv.style.borderLeft = '4px solid #4CAF50';
                
                // ì‚¬ìš©ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(loadUsers, 1000);
                
            } catch (error) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', error);
                resultDiv.innerHTML = `<strong>âŒ ì˜¤ë¥˜ ë°œìƒ:</strong><br>${error.message}`;
                resultDiv.style.borderLeft = '4px solid #C8102E';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            
            // "password"ì˜ ê¸°ë³¸ í•´ì‹œê°’ í‘œì‹œ
            document.getElementById('testPassword').value = 'password';
            testHash();
            
            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ë“œì— ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ê°’ ë¯¸ë¦¬ ì…ë ¥
            document.getElementById('updateUsername').value = 'taeul21';
            document.getElementById('updatePassword').value = 'haewon2000!';
        });
    </script>
</body>
</html>
